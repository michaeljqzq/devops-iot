{
  "manifestVersion": 1.0,
  "extensionId": "vss-continuous-delivery-pipeline-templates",
  "name": "Zhiqing Pipeline templates extension for continuous delivery",
  "publisher": "michaeljqzq",
  "version": "0.0.1",
  "description": "Zhiqing Pipeline template contributions for creating CI/CD pipelines",
  "categories": [
    "Integrate"
  ],
  "targets": [{
    "id": "Microsoft.VisualStudio.Services"
  }],
  "files": [{
    "path": "Files",
    "addressable": true
  }],
  "contributions": [{
      "id": "aspnet-windowswebapp",
      "type": "ms.vss-continuous-delivery.pipeline-template-type",
      "targets": [
        "ms.vss-continuous-delivery.pipeline-templates"
      ],
      "properties": {
        "description": "i18n:Template for configuring CI/CD pipeline for ASP.Net app on Azure windows app service",
        "attributes": {
          "codeRepositoryType": "Sample",
          "runtimeId": "michaeljqzq.vss-continuous-delivery-pipeline-templates.runtime-type-dotnet",
          "frameworkId": "michaeljqzq.vss-continuous-delivery-pipeline-templates.framework-type-iothub",
          "serviceId": "michaeljqzq.vss-continuous-delivery-pipeline-templates.service-type-existing-edge-device"
        },
        "parameters": {
          "imports": [
            "Files/Parameters/ArmEndpointParameters.json",
            "Files/Parameters/ContainerRegistryParameters.json",
            "Files/Parameters/IoTHubParameters.json",
            "Files/Parameters/VMParameters.json"
          ]
        },
        "configuration": {
          "assets": [{
              "id": "ARMResourceGroup",
              "type": "endpoint:AzureRM",
              "inputs": {
                "subscriptionId": "{{inputs.subscriptionId}}",
                "authorization": "{{inputs.azureAuth}}"
              }
          }],
          "source": {
            "repository": {
              "id": "https://github.com/michaeljqzq/temp",
              "defaultBranch": "master"
            }
          },
          "buildDefinition": {
            "queue": "hostedlinux",
            "templateFile": "Files/BuildDefinitionTemplates/buildIoTEdge.json",
            "phaseInputs": [{
              "taskInputs": [{
                "__TaskId__": "94a74903-f93f-4075-884f-dc11f34058b4",
                "ConnectedServiceName": "{{{assets.ARMResourceGroup}}}",
                "resourceGroupName": "{{{inputs.resourceGroup}}}",
                "location": "{{{inputs.containerRegistryLocation}}}",
                "csmFileLink": "https://raw.githubusercontent.com/michaeljqzq/devops-iot-sample/arm/arm-acr.json",
                "overrideParameters": "-registryName {{{inputs.containerRegistryName}}} -registrySku \"{{{inputs.containerRegistrySKU}}}\" -registryLocation \"{{{inputs.containerRegistryLocation}}}\""
              },
              {
                "__TaskId__": "80f3f6a0-82a6-4a22-ba7a-e5b8c541b9b8",
                "azureSubscriptionEndpoint": "{{{assets.ARMResourceGroup}}}",
                "azureContainerRegistry": "{\"loginServer\":\"{{{inputs.containerRegistryName}}}.azurecr.io\", \"id\" : \"/subscriptions/{{{inputs.subscriptionId}}}/resourceGroups/{{{inputs.resourceGroup}}}/providers/Microsoft.ContainerRegistry/registries/{{{inputs.containerRegistryName}}}\"}"
              },
              {
                "__TaskId__": "2ff763a7-ce83-4e1f-bc89-0ae63477cebe"
              }]
            }]
          },
          "releaseDefinition": {
            "environments": [{
              "name": "dev",
              "deployedResourceIds": [
                "/subscriptions/{{{inputs.subscriptionId}}}/resourceGroups/{{{inputs.resourceGroup}}}/providers/Microsoft.Devices/IotHubs/{{{inputs.iotHubName}}}",
                "/subscriptions/{{inputs.subscriptionId}}/resourceGroups/{{inputs.resourceGroup}}/providers/Microsoft.Compute/virtualMachines/{{inputs.vmName}}"
              ],
              "variables": {
                "vmPassword": {
                  "value": "{{{inputs.vmPassword}}}",
                  "isSecret": true
                },
                "DEVOPS_IOTEDGE_REGISTRY_URL": {
                  "value": "{{{inputs.containerRegistryName}}}.azurecr.io"
                }
              },
              "templateFile": "Files/ReleaseDefinitionTemplates/deployIoTEdge.json",
              "phaseInputs": [{
                "queue": "hostedlinux",
                "taskInputs": [{
                    "__TaskId__": "94a74903-f93f-4075-884f-dc11f34058b4",
                    "ConnectedServiceName": "{{{assets.ARMResourceGroup}}}",
                    "ResourceGroupName": "{{{inputs.resourceGroup}}}",
                    "location": "{{{inputs.iotHubLocation}}}",
                    "csmFileLink": "https://raw.githubusercontent.com/michaeljqzq/devops-iot-sample/arm/arm-iothub.json",
                    "overrideParameters": "-iotHubName {{{inputs.iotHubName}}} -iotHubSku \"{{{inputs.iotHubSku}}}\""
                  },
                  {
                    "__TaskId__": "46e4be58-730b-4389-8a2f-ea10b3e5e815",
                    "connectedServiceNameARM": "{{{assets.ARMResourceGroup}}}",
                    "inlineScript": "(az extension add --name azure-cli-iot-ext && az iot hub device-identity show --device-id myEdgeDevice --hub-name {{{inputs.iotHubName}}}) || (az iot hub device-identity create --hub-name {{{inputs.iotHubName}}} --device-id myEdgeDevice --edge-enabled && TMP_OUTPUT=\"$(az iot hub device-identity show-connection-string --device-id myEdgeDevice --hub-name {{{inputs.iotHubName}}})\" && RE=\"\\\"cs\\\":\\s?\\\"(.*)\\\"\" && if [[ $TMP_OUTPUT =~ $RE ]]; then CS_OUTPUT=${BASH_REMATCH[1]}; fi && echo \"##vso[task.setvariable variable=CS_OUTPUT]${CS_OUTPUT}\")"
                  },
                  {
                    "__TaskId__": "80f3f6a0-82a6-4a22-ba7a-e5b8c541b9b8",
                    "connectedServiceNameARM": "{{{assets.ARMResourceGroup}}}",
                    "iothubname": "{{inputs.iotHubName}}"
                  },
                  {
                    "__TaskId__": "94a74903-f93f-4075-884f-dc11f34058b4",
                    "ConnectedServiceName": "{{{assets.ARMResourceGroup}}}",
                    "ResourceGroupName": "{{{inputs.resourceGroup}}}",
                    "location": "{{{inputs.vmlocation}}}",
                    "csmFileLink": "https://raw.githubusercontent.com/michaeljqzq/devops-iot-sample/arm/arm-linux-vm.json",
                    "overrideParameters": "-edgeDeviceConnectionString $(CS_OUTPUT) -virtualMachineName \"{{{inputs.vmName}}}\" -adminUsername \"{{{inputs.vmUsername}}}\" -adminPassword \"$(vmPassword)\" -appInsightsLocation \"{{{inputs.appInsightLocation}}}\" -virtualMachineSize \"{{{inputs.vmSize}}}\" -location \"{{{inputs.vmlocation}}}\" "
                  }
                ]
              }]
            }]
          }
        }
      }
    },
    {
      "id": "runtime-type-dotnet",
      "type": "ms.vss-continuous-delivery.pipeline-attribute-descriptor-type",
      "targets": [
        "ms.vss-continuous-delivery.pipeline-attribute-descriptors"
      ],
      "properties": {
        "name": "i18n:.NET",
        "description": "i18n:New Edge solution using ASP.NET or ASP.NET Core",
        "type": "runtime",
        "iconSvgContent": "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'><rect fill='#621ee5' width='40' height='40'/><path fill='#FFFFFF' d='M5.94 25.51c-0.23 0-0.43-0.08-0.59-0.25 -0.16-0.17-0.25-0.37-0.25-0.6 0-0.23 0.08-0.43 0.25-0.6s0.36-0.25 0.59-0.25c0.24 0 0.44 0.08 0.61 0.25 0.17 0.17 0.25 0.37 0.25 0.6 0 0.23-0.08 0.43-0.25 0.6C6.38 25.43 6.18 25.51 5.94 25.51z'/><path fill='#FFFFFF' d='M17.78 25.34h-1.56l-5.59-8.65c-0.14-0.22-0.26-0.44-0.35-0.68h-0.05c0.04 0.23 0.06 0.73 0.06 1.49v7.84H9.03V14.49h1.65l5.44 8.52c0.23 0.35 0.37 0.6 0.44 0.73h0.03c-0.05-0.31-0.08-0.84-0.08-1.6V14.49h1.27V25.34z'/><path fill='#FFFFFF' d='M26.38 25.34h-5.75V14.49h5.51v1.15h-4.24v3.61h3.92v1.14h-3.92v3.8h4.48V25.34z'/><path fill='#FFFFFF' d='M34.92 15.64h-3.13v9.7h-1.27v-9.7h-3.12v-1.15h7.53V15.64z'/></svg>"
      }
    },
    {
      "id": "framework-type-iothub",
      "type": "ms.vss-continuous-delivery.pipeline-attribute-descriptor-type",
      "targets": [
        "ms.vss-continuous-delivery.pipeline-attribute-descriptors"
      ],
      "properties": {
        "name": "i18n:IoT Hub",
        "description": "i18n:IoT Hub framework",
        "type": "framework",
        "iconSvgContent": "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 40 40'><rect fill='#621ee5' width='40' height='40'/><path fill='#FFFFFF' d='M7.68 23.75H6.71L5.91 21.65H2.73l-0.75 2.1H1l2.88-7.51h0.91L7.68 23.75zM5.62 20.86l-1.18-3.2c-0.04-0.1-0.08-0.27-0.11-0.5H4.31c-0.03 0.21-0.07 0.38-0.12 0.5l-1.17 3.2H5.62z'/><path fill='#FFFFFF' d='M8.43 23.45v-1.04c0.12 0.1 0.26 0.2 0.43 0.28 0.17 0.08 0.34 0.15 0.52 0.21 0.18 0.06 0.37 0.1 0.55 0.13 0.19 0.03 0.36 0.05 0.51 0.05 0.54 0 0.94-0.1 1.21-0.3 0.27-0.2 0.4-0.49 0.4-0.87 0-0.2-0.04-0.38-0.13-0.53 -0.09-0.15-0.21-0.29-0.37-0.41 -0.16-0.12-0.34-0.24-0.56-0.36s-0.45-0.23-0.69-0.36c-0.26-0.13-0.51-0.27-0.73-0.4 -0.23-0.14-0.42-0.29-0.59-0.45 -0.17-0.16-0.3-0.35-0.4-0.56s-0.14-0.45-0.14-0.73c0-0.34 0.08-0.64 0.22-0.89 0.15-0.25 0.35-0.46 0.59-0.63 0.24-0.16 0.52-0.29 0.83-0.37 0.31-0.08 0.63-0.12 0.96-0.12 0.74 0 1.28 0.09 1.62 0.27v0.99c-0.44-0.31-1.01-0.46-1.71-0.46 -0.19 0-0.38 0.02-0.58 0.06 -0.19 0.04-0.36 0.11-0.51 0.2 -0.15 0.09-0.27 0.21-0.37 0.35 -0.09 0.14-0.14 0.32-0.14 0.52 0 0.19 0.04 0.36 0.11 0.5 0.07 0.14 0.18 0.27 0.32 0.38 0.14 0.12 0.31 0.23 0.51 0.34 0.2 0.11 0.43 0.23 0.69 0.36 0.27 0.13 0.52 0.27 0.76 0.42 0.24 0.15 0.45 0.31 0.63 0.49 0.18 0.18 0.32 0.38 0.43 0.59 0.11 0.22 0.16 0.46 0.16 0.74 0 0.37-0.07 0.68-0.22 0.94 -0.15 0.26-0.34 0.47-0.59 0.63 -0.25 0.16-0.53 0.28-0.85 0.35 -0.32 0.07-0.66 0.11-1.02 0.11 -0.12 0-0.27-0.01-0.44-0.03 -0.17-0.02-0.35-0.05-0.53-0.08C9.16 23.73 8.99 23.68 8.82 23.63S8.53 23.52 8.43 23.45z'/><path fill='#FFFFFF' d='M15.36 20.92v2.84h-0.88v-7.51h2.06c0.8 0 1.43 0.2 1.87 0.59 0.44 0.39 0.66 0.94 0.66 1.65s-0.25 1.29-0.74 1.75c-0.49 0.45-1.15 0.68-1.99 0.68H15.36zM15.36 17.04v3.08h0.92c0.61 0 1.07-0.14 1.39-0.42 0.32-0.28 0.48-0.67 0.48-1.18 0-0.99-0.59-1.49-1.76-1.49H15.36z'/><path fill='#FFFFFF' d='M18.96 23.87c-0.16 0-0.3-0.06-0.41-0.17 -0.11-0.12-0.17-0.25-0.17-0.41 0-0.16 0.06-0.3 0.17-0.42 0.11-0.12 0.25-0.17 0.41-0.17 0.16 0 0.3 0.06 0.42 0.17 0.12 0.12 0.17 0.26 0.17 0.42 0 0.16-0.06 0.3-0.17 0.41C19.26 23.81 19.12 23.87 18.96 23.87z'/><path fill='#FFFFFF' d='M27.15 23.75h-1.08l-3.86-5.98c-0.1-0.15-0.18-0.31-0.24-0.47h-0.03c0.03 0.16 0.04 0.5 0.04 1.03v5.42h-0.88v-7.51h1.14l3.76 5.89c0.16 0.24 0.26 0.41 0.3 0.5h0.02c-0.04-0.22-0.05-0.58-0.05-1.1v-5.29h0.88V23.75z'/><path fill='#FFFFFF' d='M33.1 23.75h-3.98v-7.51h3.81v0.8h-2.93v2.5h2.71v0.79h-2.71v2.63h3.1V23.75z'/><path fill='#FFFFFF' d='M39 17.04h-2.17v6.71h-0.88v-6.71h-2.16v-0.8H39V17.04z'/></svg>"
      }
    },
    {
      "id": "service-type-existing-edge-device",
      "type": "ms.vss-continuous-delivery.pipeline-attribute-descriptor-type",
      "targets": [
        "ms.vss-continuous-delivery.pipeline-attribute-descriptors"
      ],
      "properties": {
        "name": "i18n:Existing Edge device",
        "description": "i18n:Existing edge device.",
        "type": "resource",
        "iconSvgContent": "<?xml version='1.0' encoding='utf-8'?> <svg version='1.1' id='Layer_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' \t width='50px' height='50px' viewBox='0 0 50 50' enable-background='new 0 0 50 50' xml:space='preserve'> <path fill='#59B4D9' d='M40.193,44.839c-4.53,3.464-9.867,5.151-15.167,5.151c-7.52,0-14.956-3.376-19.87-9.803 \tC-3.24,29.225-1.168,13.548,9.814,5.148C14.343,1.663,19.686,0,24.979,0c7.52,0,14.958,3.376,19.87,9.809 \tC53.247,20.768,51.154,36.448,40.193,44.839'/> <path fill='#FFFFFF' d='M35.6,29.378c1.816,2.368,5.186,2.796,7.541,1.004c0.123-0.094,0.218-0.208,0.33-0.309 \tc2.409,1.697,4.082,2.817,5.025,3.459c0.279-0.723,0.472-1.417,0.67-2.142c-0.996-0.741-2.343-1.778-4.29-3.356 \tc0.639-1.68,0.437-3.64-0.73-5.171c-1.669-2.16-4.626-2.709-6.936-1.377c-2.546-2.284-5.343-4.902-8.293-7.833 \tc9.165-4.929,15.676-4.207,15.676-4.207c-1.087-1.386-2.305-2.6-3.606-3.697c-3.865-0.597-9.869-0.53-16.729,3.119l-0.002-0.003 \tl-0.001,0c-2.286-2.393-4.613-4.958-6.983-7.712c-1.134,0.363-2.242,0.812-3.312,1.347c1.749,2.862,4.102,5.749,6.754,8.565h0 \tc0.005,0.006,0.011,0.011,0.017,0.017c-2.211,1.546-4.673,3.613-6.944,6.015c-0.29,0.309-0.569,0.62-0.842,0.931 \tc-1.357-0.284-2.784-0.201-4.117,0.282C6.564,13.425,6.746,9.501,7.104,7.478c-0.983,1.03-1.901,2.113-2.692,3.267 \tC3.821,13.16,3.653,16.643,5.397,20.84c-2.019,2.642-2.114,6.389-0.005,9.153c0.176,0.229,0.364,0.442,0.559,0.645 \tc-0.921,3.137-1.333,6.163-1.46,8.761c0.237,0.322,0.237,0.582,0.472,0.896c1.199,1.538,2.705,2.834,4.16,4.008 \tc-0.18-2.75,0.014-6.806,1.714-11.372c1.173,0.089,2.366-0.096,3.483-0.566c0.64,0.563,1.31,1.132,2.025,1.711 \tc2.453,1.942,4.9,3.453,7.285,4.643c-0.124,1.213,0.18,2.474,0.968,3.518c1.685,2.176,4.805,2.582,6.983,0.919 \tc0.453-0.347,0.811-0.766,1.108-1.216c3.889,0.866,7.287,1.019,9.806,1.019c0.386,0,2.177-2.436,3.203-3.946 \tc-1.534,0.321-6.083,0.946-12.3-0.84c-0.15-0.698-0.437-1.376-0.898-1.98c-1.579-2.07-4.466-2.518-6.618-1.133 \tc-2.161-1.172-4.424-2.641-6.758-4.49c-0.471-0.373-0.923-0.745-1.359-1.118c1.426-2.247,1.578-5.127,0.318-7.55 \tc0.286-0.286,0.567-0.573,0.871-0.857c2.311-2.159,4.485-3.887,6.519-5.274c-0.082-0.076-0.156-0.156-0.236-0.233 \tc0.081,0.075,0.157,0.152,0.239,0.227c-0.001,0-0.001,0.001-0.002,0.001c3.121,2.886,6.43,5.621,9.564,8.065 \tC34.209,25.589,34.339,27.73,35.6,29.378z'/> </svg> "
      }
    }
  ]
}
